name: Test cypress

on: [push]

jobs:
#   frontend_tests:
#     runs-on: ubuntu-latest
#     strategy:
#       fail-fast: false
#       matrix:
#         browser: [chrome, firefox]
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v2

    #   - name: Set up Node.js
    #     uses: actions/setup-node@v3
    #     with:
    #       node-version: '16'

    #   - name: Install dependencies
    #     run: npm install

    #   - name: Build project
    #     run: npm run build

    #   - name: Start application
    #     run: npm start &
    #     env:
    #       NODE_ENV: production

    #   - name: Wait for the application to be ready
    #     run: npx wait-on http://localhost:3000

    #   - name: Run Frontend Tests
    #     run: npx cypress run --spec "cypress/e2e/frontend/*.cy.ts" --browser ${{ matrix.browser }}

  endpoint_tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Start JSON server
        run: npm run run:server &

      - name: Wait for the application json server to be ready
        run: npx wait-on http://localhost:3000

      - name: Run Endpoint Tests
        run: npx cypress run --spec "cypress/e2e/backend/*.cy.ts" --browser chrome

      - name: Slack Notification
        if: success() # Notifica siempre, independientemente del resultado del trabajo
        uses: rtCamp/action-slack-notify@v2.1.2
        with:
          status: ${{ job.status }}
          config: .github/config/slack.yml
        env:
          SLACK_CHANNEL: automation-cypress-github
          SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
          SLACK_ICON: https://user-images.githubusercontent.com/4115/54997488-d1f94e00-4ff1-11e9-897f-a35ab90f525f.png
          SLACK_MESSAGE: 'Result test'
          SLACK_TITLE: üòé STATUS TEST
          SLACK_USERNAME: üëæ David-Bot
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      #   run: |
      #     curl -X POST -H 'Content-type: application/json' \
      #     --data '{"text":"‚úÖ Cypress endpoint tests passed successfully!"}' \
      #     ${{ secrets.SLACK_WEBHOOK_URL }}

      # - name: Notify Slack on Failure
      #   if: failure()
      #   run: |
      #     curl -X POST -H 'Content-type: application/json' \
      #     --data '{"text":"‚ùå Cypress endpoint tests failed. Please check the logs for details."}' \
      #     ${{ secrets.SLACK_WEBHOOK_URL }}

